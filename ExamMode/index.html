<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TutorAI - Exam Mode</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    header { padding: 16px 20px; background: #111827; border-bottom: 1px solid #1f2937; display:flex; align-items:center; gap:12px; }
    .badge { background:#1f2937; color:#a7f3d0; border:1px solid #374151; padding:4px 8px; border-radius:12px; font-size:12px; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .panel { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    .row { display:flex; gap:16px; }
    .left { flex: 3; }
    .right { flex: 1.2; }
    .controls { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-bottom:12px; }
    select, input, button { width:100%; padding:10px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#e2e8f0; }
    button.primary { background:#2563eb; border-color:#1d4ed8; cursor:pointer; }
    button.secondary { background:#10b981; border-color:#059669; cursor:pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .chat { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .msg { padding:12px; border-radius:10px; background:#0b1220; border:1px solid #1f2937; }
    .msg.user { background:#111827; }
    .question { white-space: pre-wrap; }
    .choices { margin-top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .progress { height:10px; background:#1f2937; border-radius:8px; overflow:hidden; }
    .progress > div { height:100%; background: linear-gradient(90deg, #10b981, #22d3ee); width:0%; transition: width 0.5s ease; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .meta .pill { padding:4px 8px; border-radius:12px; background:#0b1220; border:1px solid #1f2937; font-size:12px; }
    .badges { display:flex; gap:6px; flex-wrap:wrap; }
    .badges .b { padding:4px 8px; background:#1f2937; border:1px solid #374151; border-radius:8px; font-size:12px; }
    .footer { margin-top: 30px; font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:700; font-size:18px;">TutorAI â€¢ Exam Mode</div>
    <div class="badge">Beta</div>
  </header>
  <div id="root" class="container"></div>

  <script type="text/babel">
    const API_BASE = '' // same origin

    function useExamMode() {
      const [sessionId, setSessionId] = React.useState('')
      const [subject, setSubject] = React.useState('Maths')
      const [term, setTerm] = React.useState('Third term')
      const [mode, setMode] = React.useState('practice')
      const [loading, setLoading] = React.useState(false)
      const [question, setQuestion] = React.useState(null)
      const [answer, setAnswer] = React.useState('')
      const [log, setLog] = React.useState([])
      const [progress, setProgress] = React.useState({ points: 0, streak: 0, badges: [], readiness_percent: 0 })

      const append = (entry) => setLog(prev => [...prev, entry])

      async function start() {
        setLoading(true)
        try {
          const res = await fetch(`${API_BASE}/exam-mode/start`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode, term, subject })
          })
          if (!res.ok) throw new Error('Failed to start')
          const data = await res.json()
          setSessionId(data.session_id)

          const fp = await fetch(`${API_BASE}/exam-mode/fetch-papers`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: data.session_id, term, subject })
          })
          if (!fp.ok) throw new Error('Failed to fetch papers')
          const fpData = await fp.json()
          append({ role: 'system', text: `Loaded ${fpData.total_questions} questions across years: ${Object.keys(fpData.papers).join(', ')}` })

          await askQuestion(data.session_id)
        } catch (e) {
          append({ role: 'system', text: 'Error: ' + e.message })
        } finally {
          setLoading(false)
        }
      }

      async function askQuestion(sid = sessionId) {
        setLoading(true)
        try {
          const res = await fetch(`${API_BASE}/exam-mode/ask-question`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sid })
          })
          if (!res.ok) throw new Error('Failed to ask question')
          const data = await res.json()
          setQuestion(data.question)
          setProgress(data.progress)
          append({ role: 'system', text: `Question from ${data.question.year} (${data.question.type})` })
        } catch (e) {
          append({ role: 'system', text: 'Error: ' + e.message })
        } finally {
          setLoading(false)
        }
      }

      async function submitAnswer() {
        if (!question) return
        setLoading(true)
        try {
          append({ role: 'user', text: answer })
          const res = await fetch(`${API_BASE}/exam-mode/evaluate`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, question_id: question.id, user_answer: answer })
          })
          if (!res.ok) throw new Error('Failed to evaluate')
          const data = await res.json()
          const feedback = []
          if (data.correct) {
            feedback.push(`Correct! +${data.points_awarded} points.`)
          } else {
            feedback.push(data.explanation || 'Incorrect.')
            if (data.mastery_steps) {
              feedback.push('Mastery steps:')
              data.mastery_steps.forEach(s => feedback.push(`- ${s.title}: ${s.content}`))
            }
          }
          if (data.badge_earned) feedback.push(`Badge earned: ${data.badge_earned}`)
          setProgress(data.progress)
          append({ role: 'system', text: feedback.join('\n') })
          setAnswer('')
          await askQuestion()
        } catch (e) {
          append({ role: 'system', text: 'Error: ' + e.message })
        } finally {
          setLoading(false)
        }
      }

      return {
        sessionId, subject, setSubject, term, setTerm, mode, setMode,
        loading, question, answer, setAnswer, log, progress,
        start, submitAnswer
      }
    }

    function App() {
      const em = useExamMode()

      return (
        <div className="row">
          <div className="left">
            <div className="panel">
              <div className="controls">
                <select value={em.mode} onChange={e => em.setMode(e.target.value)}>
                  <option value="real">Real exam</option>
                  <option value="practice">Practice</option>
                </select>
                <select value={em.term} onChange={e => em.setTerm(e.target.value)}>
                  <option>First term</option>
                  <option>Second term</option>
                  <option>Third term</option>
                </select>
                <select value={em.subject} onChange={e => em.setSubject(e.target.value)}>
                  <option>Maths</option>
                  <option>Science</option>
                  <option>English</option>
                </select>
              </div>
              <div style={{ display:'flex', gap:12 }}>
                <button className="primary" onClick={em.start} disabled={em.loading}>Start Exam Mode</button>
                <button className="secondary" disabled>Enter Exam Mode (UI Button)</button>
              </div>

              <div className="chat">
                {em.question && (
                  <div className="msg">
                    <div className="question">{em.question.text}</div>
                    {em.question.choices && (
                      <div className="choices">
                        {em.question.choices.map((c,i) => (
                          <button key={i} onClick={() => em.setAnswer(c)} disabled={em.loading}>{c}</button>
                        ))}
                      </div>
                    )}
                  </div>
                )}
                {em.log.map((m, i) => (
                  <div key={i} className={`msg ${m.role}`}>
                    <pre style={{ margin:0, whiteSpace:'pre-wrap' }}>{m.text}</pre>
                  </div>
                ))}
              </div>

              <div style={{ display:'flex', gap:8, marginTop:12 }}>
                <input placeholder="Type your answer..." value={em.answer} onChange={e => em.setAnswer(e.target.value)} />
                <button onClick={em.submitAnswer} disabled={em.loading || !em.question}>Submit</button>
              </div>

              <div className="footer">Trigger phrases (handled client-side): "Prepare me for my third exam", "I want to practice for my exam"</div>
            </div>
          </div>
          <div className="right">
            <div className="panel">
              <div style={{ fontWeight:700, marginBottom:8 }}>Progress</div>
              <div className="progress" title={`${em.progress.readiness_percent}% ready`}>
                <div style={{ width: `${em.progress.readiness_percent || 0}%` }}></div>
              </div>
              <div className="meta">
                <div className="pill">Points: {em.progress.points || 0}</div>
                <div className="pill">Streak: {em.progress.streak || 0}</div>
              </div>
              <div style={{ marginTop:12 }}>
                <div style={{ fontWeight:600, marginBottom:4 }}>Badges</div>
                <div className="badges">
                  {(em.progress.badges || []).length === 0 && <div className="b">No badges yet</div>}
                  {(em.progress.badges || []).map((b, i) => (<div className="b" key={i}>{b}</div>))}
                </div>
              </div>
            </div>
          </div>
        </div>
      )
    }

    const root = ReactDOM.createRoot(document.getElementById('root'))
    root.render(<App />)
  </script>
</body>
</html>