<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grade 9 AI Tutor</title>
  <style>
    :root{
      /* Dark (default) Copilot-grade with Apple glass */
      --bg:#070a12; --bg1:#0b1224; --bg2:#0a0f1e;
      --panel: rgba(16,22,35,0.58); --panel-strong: rgba(16,22,35,0.78);
      --text:#eaf2ff; --muted:#9fb1c8; --border: rgba(255,255,255,0.12);
      --accent:#7cc4ff; --accent-2:#22d3ee; --danger:#ef4444; --ok:#22c55e;
      --blur:22px; --shadow: 0 12px 32px rgba(0,0,0,0.38);
    }
    :root[data-theme="light"]{
      /* Milky light glass with soft pastels */
      --bg:#eef1f7; --bg1:#fbfcff; --bg2:#eef2ff;
      --panel: rgba(255,255,255,0.68); --panel-strong: rgba(255,255,255,0.82);
      --text:#0b1324; --muted:#546070; --border: rgba(15,23,42,0.10);
      --accent:#5aa1ff; --accent-2:#9b8cff; --danger:#b91c1c; --ok:#16a34a;
      --blur:24px; --shadow: 0 12px 28px rgba(17,24,39,0.12);
    }

    html,body { height:100%; }
    body {
      margin:0; font-family: ui-sans-serif, system-ui, "Segoe UI", Roboto, -apple-system, Arial, sans-serif;
      display:grid; grid-template-columns: 280px 1fr; grid-template-rows: 64px 1fr 96px; grid-template-areas:
        "sidebar header" "sidebar main" "sidebar composer";
      color:var(--text);
      background:
        radial-gradient(1200px 720px at 12% -14%, rgba(124,196,255,0.20), transparent 60%),
        radial-gradient(1000px 560px at 88% -8%, rgba(34,211,238,0.18), transparent 60%),
        radial-gradient(1400px 900px at 50% 120%, rgba(167,139,250,0.15), transparent 65%),
        radial-gradient(1200px 900px at 50% 130%, rgba(0,0,0,0.35), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }
    body.full { grid-template-columns: 1fr; grid-template-areas: "header" "main" "composer"; }

    /* Orbs */
    .orbs{ position:fixed; inset:0; z-index:-2; overflow:hidden; pointer-events:none; }
    .orb{ position:absolute; left:var(--x); top:var(--y); width:var(--s); height:var(--s);
      background: radial-gradient(closest-side, var(--c), rgba(0,0,0,0)); filter: blur(40px);
      border-radius:50%; animation: drift var(--h) ease-in-out infinite alternate; }
    @keyframes drift{ from{ transform: translate(-20px, 10px) scale(1);} to{ transform: translate(20px, -10px) scale(1.08);} }

    /* Header */
    .header{ grid-area:header; display:flex; align-items:center; justify-content:space-between; padding:0 16px;
      background:var(--panel); border-bottom:1px solid var(--border); box-shadow:var(--shadow);
      backdrop-filter: saturate(180%) blur(var(--blur)); -webkit-backdrop-filter: saturate(180%) blur(var(--blur));
      position:relative; overflow:hidden; }
    .left{ display:flex; gap:8px; align-items:center; }
    .icon{ width:42px; height:42px; border-radius:12px; border:1px solid var(--border); background:var(--panel-strong);
      color:var(--text); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow);
      transition: transform .2s ease, background .3s ease, border-color .3s ease; }
    .icon:hover{ transform: translateY(-1px); border-color:var(--accent); background:linear-gradient(180deg, rgba(124,196,255,0.25), rgba(34,211,238,0.22)); }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px; }
    .brand .title{ font-size:16px; background:linear-gradient(90deg, var(--accent), var(--accent-2)); background-clip:text; -webkit-background-clip:text; color:transparent; }
    .badge{ padding:4px 10px; font-size:11px; border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(124,196,255,0.18), rgba(34,211,238,0.16)); }
    .controls{ display:flex; align-items:center; gap:10px; }
    .select{ background:var(--panel-strong); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:8px 12px; font-size:14px;
      transition: border-color .3s ease, background .3s ease; box-shadow:var(--shadow), inset 0 1px rgba(255,255,255,.18), inset 0 -1px rgba(0,0,0,.25); }
    .select:hover{ border-color:var(--accent); }

    /* Sidebar */
    .sidebar{ grid-area:sidebar; background:var(--panel); border-right:1px solid var(--border); box-shadow:var(--shadow);
      backdrop-filter: saturate(180%) blur(var(--blur)); -webkit-backdrop-filter: saturate(180%) blur(var(--blur));
      overflow:auto; position:relative; transition: transform 420ms cubic-bezier(.22,.61,.36,1), opacity 300ms ease; }
    .sidebar.hidden{ transform:translateX(-105%); opacity:0; }
    .sidebar .heading{ padding:16px; font-weight:700; letter-spacing:.2px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
    .quick{ padding:10px 12px; display:flex; flex-direction:column; gap:8px; border-bottom:1px solid var(--border); }
    .qa{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer; border:1px solid var(--border); background:var(--panel-strong); transition: all .2s ease; }
    .qa:hover{ border-color:var(--accent); background:linear-gradient(180deg, rgba(124,196,255,0.18), rgba(34,211,238,0.16)); transform: translateY(-1px); }
    .history{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .chip{ padding:10px 14px; border-radius:14px; background:var(--panel-strong); border:1px solid var(--border); cursor:pointer; transition: all .25s ease; }
    .chip:hover{ background:linear-gradient(180deg, rgba(124,196,255,0.18), rgba(34,211,238,0.16)); border-color:var(--accent); transform: translateY(-1px); }
    .chip.active{ border-color:var(--accent); box-shadow:0 0 0 1px rgba(124,196,255,0.25) inset; }

    /* Main */
    .main{ grid-area:main; padding:24px; overflow:auto; display:flex; flex-direction:column; align-items:center; gap:18px; }
    .welcome{ font-size:32px; font-weight:800; margin:0 0 8px; background:linear-gradient(90deg, var(--accent), var(--accent-2));
      background-clip:text; -webkit-background-clip:text; color:transparent; }
    .home-grid{ width:100%; max-width:1120px; display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
    .card{ grid-column: span 6; min-height:160px; border-radius:24px; padding:18px; background:var(--panel); border:1px solid var(--border);
      box-shadow:var(--shadow); backdrop-filter: saturate(180%) blur(var(--blur)); -webkit-backdrop-filter: saturate(180%) blur(var(--blur)); position:relative; overflow:hidden; }
    .card h3{ margin:0 0 8px; font-size:16px; opacity:.9; }
    .card .content{ font-size:14px; color:var(--muted); }
    .card.large{ grid-column: span 12; }
    .thread{ width:100%; max-width:920px; opacity:0; transform: translateY(10px); transition: opacity .35s ease, transform .35s ease; }
    .thread.visible{ opacity:1; transform: translateY(0); }

    /* Messages */
    .row{ display:flex; width:100%; margin:8px 0; }
    .bubble{ padding:14px 16px; border-radius:18px; line-height:1.55; word-wrap:break-word; white-space:pre-wrap; border:1px solid var(--border);
      background:var(--panel-strong); box-shadow:0 2px 8px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.06) inset;
      backdrop-filter: saturate(180%) blur(var(--blur)); -webkit-backdrop-filter: saturate(180%) blur(var(--blur)); position:relative; overflow:hidden; }
    .row.user .bubble{ margin-left:auto; border-bottom-right-radius:6px; }
    .row.ai .bubble{ margin-right:auto; border-bottom-left-radius:6px; }
    .pop{ animation: pop .42s cubic-bezier(.22,.61,.36,1) both; }
    @keyframes pop{ 0%{ opacity:0; transform: translateY(8px) scale(.98);} 60%{ opacity:1; transform: translateY(0) scale(1.02);} 100%{ transform: translateY(0) scale(1);} }

    /* Composer */
    .composer{ grid-area:composer; display:flex; align-items:center; gap:10px; padding:16px 20px; border-top:1px solid var(--border); background:var(--panel);
      backdrop-filter: saturate(180%) blur(var(--blur)); -webkit-backdrop-filter: saturate(180%) blur(var(--blur)); box-shadow:var(--shadow); }
    .input{ flex:1; padding:14px 16px; border-radius:14px; border:1px solid var(--border); background:var(--panel-strong); color:var(--text); font-size:15px;
      box-shadow: inset 0 1px rgba(255,255,255,.18), inset 0 -1px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.04); }
    .input:focus{ outline:none; border-color:var(--accent); }
    .send{ width:42px; height:42px; border-radius:12px; border:1px solid var(--border); background:var(--panel-strong); color:var(--text);
      display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow); transition: transform .2s ease, background .3s ease; }
    .send:hover{ transform: translateY(-1px); border-color:var(--accent); background:linear-gradient(180deg, rgba(124,196,255,0.25), rgba(34,211,238,0.22)); }

    /* Utilities */
    .hidden{ display:none !important; }
    .fade-in{ animation: fade .35s ease both; }
    @keyframes fade{ from{ opacity:0; transform: translateY(-10px);} to { opacity:1; transform: translateY(0);} }

    /* Sheen */
    .sheen::after{ content:""; position:absolute; inset:-10% -20%; pointer-events:none; opacity:.22;
      background: linear-gradient(110deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.18) 45%, rgba(255,255,255,0) 60%);
      transform: translateX(-120%); animation: sheen 4.8s linear infinite; }
    @keyframes sheen{ from{ transform:translateX(-120%);} to{ transform:translateX(120%);} }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }

    /* Mobile */
    @media (max-width: 900px){ body{ grid-template-columns:1fr; grid-template-rows:64px 1fr 100px; grid-template-areas: "header" "main" "composer"; } .sidebar{ display:none; } }
  </style>
</head>
<body>
  <!-- Ambient orbs -->
  <div class="orbs" aria-hidden="true">
    <div class="orb" style="--x:8%; --y:12%; --s:260px; --h:220s; --c:rgba(124,196,255,0.30)"></div>
    <div class="orb" style="--x:86%; --y:10%; --s:220px; --h:260s; --c:rgba(34,211,238,0.28)"></div>
    <div class="orb" style="--x:50%; --y:86%; --s:340px; --h:300s; --c:rgba(167,139,250,0.22)"></div>
  </div>

  <aside id="sidebar" class="sidebar sheen">
    <div class="heading"><span>Menu</span></div>
    <div class="quick">
      <div id="qaNew" class="qa">üìù <span>New chat</span></div>
      <div id="qaSearch" class="qa">üîé <span>Search chats</span></div>
      <div id="qaLibrary" class="qa">üìö <span>Library</span></div>
      <div id="qaProjects" class="qa">üìÅ <span>Projects</span></div>
    </div>
    <div class="heading"><span>Chats</span></div>
    <div id="history" class="history"></div>
  </aside>

  <header class="header sheen">
    <div class="left">
      <button id="toggleSidebar" class="icon" title="Toggle Sidebar">‚ò∞</button>
      <button id="homeBtn" class="icon" title="Home">üè†</button>
      <div class="brand">
        <div class="title">Grade 9 AI Tutor</div>
        <div class="badge">Liquid Glass</div>
      </div>
    </div>
    <div class="controls">
      <select id="subjectSelect" class="select" title="Subject">
        <option value="General">General</option>
        <option value="Math">Math</option>
        <option value="Science">Science</option>
        <option value="History">History</option>
        <option value="English">English</option>
      </select>
      <select id="langSelect" class="select" title="Language">
        <option value="English">English</option>
        <option value="Sinhala">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</option>
      </select>
      <select id="themeSelect" class="select" title="Theme">
        <option value="system">System</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>
  </header>

  <main id="main" class="main">
    <h1 id="welcomeTitle" class="welcome fade-in">Welcome to Tutor</h1>
    <div id="homeGrid" class="home-grid">
      <div class="card large sheen" id="newsCard"><h3>Today‚Äôs News</h3><div class="content" id="newsContent">Loading top stories‚Ä¶</div></div>
      <div class="card sheen" id="weatherCard"><h3>Weather Forecast</h3><div class="content" id="weatherContent">Locating‚Ä¶</div></div>
      <div class="card sheen" id="trendCard"><h3>Trending Topics</h3><div class="content" id="trendContent">Fetching‚Ä¶</div></div>
      <div class="card sheen" id="scoresCard"><h3>Live Match Scores</h3><div class="content" id="scoresContent">Loading‚Ä¶</div></div>
      <div class="card large sheen" id="historyCard"><h3>Your History</h3><div class="content" id="homeHistory">No conversations yet ‚Äî start one below!</div></div>
    </div>
    <div id="thread" class="thread">
      <div id="answers"></div>
    </div>
  </main>

  <div class="composer">
    <input id="input" class="input" placeholder="Ask anything..." />
    <button id="micBtn" class="send" title="Speak">üé§</button>
    <button id="sendBtn" class="send" title="Send">‚û§</button>
  </div>

  <script>
    const body=document.body;
    const sidebar=document.getElementById('sidebar');
    const toggleSidebar=document.getElementById('toggleSidebar');
    const subjectSelect=document.getElementById('subjectSelect');
    const langSelect=document.getElementById('langSelect');
    const themeSelect=document.getElementById('themeSelect');
    const main=document.getElementById('main');
    const welcomeTitle=document.getElementById('welcomeTitle');
    const homeGrid=document.getElementById('homeGrid');
    const homeHistory=document.getElementById('homeHistory');
    const newsContent=document.getElementById('newsContent');
    const weatherContent=document.getElementById('weatherContent');
    const trendContent=document.getElementById('trendContent');
    const scoresContent=document.getElementById('scoresContent');
    const thread=document.getElementById('thread');
    const answers=document.getElementById('answers');
    const input=document.getElementById('input');
    const sendBtn=document.getElementById('sendBtn');
    const micBtn=document.getElementById('micBtn');

    // State
    let chats=[]; let activeChatId=null;
    function saveState(){ localStorage.setItem('ai_tutor_chats', JSON.stringify({chats, activeChatId})); }
    function loadState(){
      try{ const raw=localStorage.getItem('ai_tutor_chats'); if(!raw) return; const s=JSON.parse(raw); chats=s.chats||[]; activeChatId=s.activeChatId||null; }catch{ chats=[]; activeChatId=null; }
    }

    // Theme handling
    const THEME_KEY='ai_tutor_theme';
    const mql=window.matchMedia('(prefers-color-scheme: dark)');
    function applyTheme(mode){
      const m= mode || localStorage.getItem(THEME_KEY) || 'system';
      themeSelect.value=m;
      if(m==='system'){ document.documentElement.setAttribute('data-theme', mql.matches?'dark':'light'); }
      else { document.documentElement.setAttribute('data-theme', m); }
    }
    themeSelect.addEventListener('change',()=>{ localStorage.setItem(THEME_KEY, themeSelect.value); applyTheme(themeSelect.value); });
    mql.addEventListener?.('change',()=>{ if((localStorage.getItem(THEME_KEY)||'system')==='system') applyTheme('system'); });

    // UI helpers
    function showHomepage(){
      welcomeTitle.classList.remove('hidden'); homeGrid.classList.remove('hidden');
      thread.classList.remove('visible');
    }
    function showThread(){
      welcomeTitle.classList.add('hidden'); homeGrid.classList.add('hidden');
      thread.classList.add('visible');
    }

    function renderHistory(){
      const history=document.getElementById('history'); history.innerHTML=''; homeHistory.innerHTML='';
      chats.forEach(c=>{
        const chip=document.createElement('div'); chip.className='chip'+(c.id===activeChatId?' active':''); chip.textContent=c.title||'New Chat';
        chip.onclick=()=>{ activeChatId=c.id; renderHistory(); renderChat(); saveState(); };
        history.appendChild(chip);
        const pill=document.createElement('div'); pill.className='chip'; pill.textContent=c.title||'New Chat'; pill.onclick=chip.onclick; homeHistory.appendChild(pill);
      });
      if(chats.length===0){ homeHistory.textContent='No conversations yet ‚Äî start one below!'; }
    }

    function renderChat(){
      const chat=chats.find(c=>c.id===activeChatId);
      if(!chat || chat.messages.length===0){ answers.innerHTML=''; showHomepage(); return; }
      answers.innerHTML='';
      chat.messages.forEach(m=>{
        const row=document.createElement('div'); row.className='row '+(m.role==='user'?'user':'ai');
        const bubble=document.createElement('div'); bubble.className='bubble sheen pop';
        if(m.role==='ai' && m.content==='__typing__'){
          bubble.innerHTML='<span style="display:inline-flex;gap:6px"><span class="dot"></span></span>';
          const typing=document.createElement('span'); typing.className='typing'; typing.innerHTML='<span class="d"></span><span class="d"></span><span class="d"></span>';
          bubble.innerHTML=''; bubble.appendChild(typing);
        }else{ bubble.textContent=m.content; }
        row.appendChild(bubble); answers.appendChild(row);
      });
      showThread(); answers.scrollTop=answers.scrollHeight;
    }

    function createNewChat(){ const id='chat_'+Date.now(); chats.push({id,title:'New Chat',messages:[]}); activeChatId=id; saveState(); renderHistory(); renderChat(); }

    async function api(path, payload){
      const res=await fetch(`http://127.0.0.1:8000/${path}`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      return res.json();
    }

    async function generateTitle(question){
      const subject=subjectSelect.value; const language=langSelect.value;
      try{ const data=await api('generate_title',{ question, subject, language }); return data.title || question.slice(0,36); }catch{ return question.slice(0,36); }
    }

    let cachedLoc=null;
    async function getLocation(){
      if(cachedLoc!==null) return cachedLoc;
      cachedLoc = await new Promise(resolve=>{
        if(!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(p=>resolve({lat:p.coords.latitude, lon:p.coords.longitude}), ()=>resolve(null), {timeout:5000});
      });
      return cachedLoc;
    }

    async function sendMessage(){
      const text=input.value.trim(); if(!text) return;
      const subject=subjectSelect.value; const language=langSelect.value;
      let chat=chats.find(c=>c.id===activeChatId); if(!chat){ createNewChat(); chat=chats.find(c=>c.id===activeChatId); }
      if(chat.messages.length===0){ const t=await generateTitle(text); chat.title=t; saveState(); renderHistory(); }

      chat.messages.push({ role:'user', content:`[${language}] ${text}` }); renderChat(); input.value='';
      chat.messages.push({ role:'ai', content:'__typing__' }); saveState(); renderChat();

      try{
        const loc=await getLocation();
        const payload={ subject, language, student_question:text, title:chat.title, email:'guest@student.com' };
        if(loc){ payload.lat=loc.lat; payload.lon=loc.lon; }
        const data=await api('ask',payload);
        chat.messages[chat.messages.length-1].content= data.answer || data.error || 'No response';
      }catch{ chat.messages[chat.messages.length-1].content='Error contacting backend'; }
      saveState(); renderChat();
    }

    // Events
    toggleSidebar.onclick=()=>{ sidebar.classList.toggle('hidden'); body.classList.toggle('full'); };
    document.getElementById('homeBtn').onclick=()=>{ showHomepage(); };
    document.getElementById('qaNew').onclick=()=>{ createNewChat(); showThread(); };
    document.getElementById('qaSearch').onclick=()=>{ alert('Search UI coming soon'); };
    document.getElementById('qaLibrary').onclick=()=>{ alert('Library coming soon'); };
    document.getElementById('qaProjects').onclick=()=>{ alert('Projects coming soon'); };
    sendBtn.onclick=sendMessage;
    input.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
    input.addEventListener('input',()=>{ const chat=chats.find(c=>c.id===activeChatId); if(!chat || chat.messages.length>0) return; showThread(); });

    // Mic (best-effort Web Speech API)
    let recognition; if('webkitSpeechRecognition' in window){ recognition=new webkitSpeechRecognition(); recognition.continuous=false; recognition.interimResults=false; recognition.onresult=(e)=>{ input.value=e.results[0][0].transcript; }; }
    micBtn.onclick=()=>{ if(!recognition) return alert('Speech recognition not supported'); recognition.lang=langSelect.value==='Sinhala'?'si-LK':'en-US'; recognition.start(); };

    // Dashboard data via backend aggregate
    async function populateDashboard(){
      // try geolocation for weather
      const loc = await new Promise(resolve=>{
        if(!navigator.geolocation){ return resolve(null); }
        navigator.geolocation.getCurrentPosition(p=>resolve({lat:p.coords.latitude, lon:p.coords.longitude}), ()=>resolve(null), {timeout:5000});
      });
      const q = loc? `?lat=${loc.lat}&lon=${loc.lon}` : '';
      try{
        const res = await fetch(`http://127.0.0.1:8000/live/aggregate${q}`);
        const data = await res.json();
        // News
        if(data.news?.items?.length){ newsContent.innerHTML = data.news.items.slice(0,6).map(n=>`‚Ä¢ <a href="${n.url}" target="_blank">${n.title}</a>`).join('<br/>'); }
        else { newsContent.textContent='No headlines available'; }
        // Trends
        if(data.trending?.items?.length){ trendContent.innerHTML = data.trending.items.slice(0,8).map(t=>`‚Ä¢ ${t}`).join('<br/>'); }
        else { trendContent.textContent='No trend data'; }
        // Scores
        if(data.scores?.items?.length){ scoresContent.innerHTML = data.scores.items.slice(0,6).map(s=>`‚Ä¢ <a href="${s.url}" target="_blank">${s.title}</a> <span style="opacity:.7">(${s.competition})</span>`).join('<br/>'); }
        else { scoresContent.textContent='No live scores'; }
        // Weather
        const cw = data.weather?.current_weather; if(cw){ weatherContent.textContent = `${cw.temperature}¬∞C, wind ${cw.windspeed} km/h`; }
        else if(loc===null){ weatherContent.textContent='Location blocked'; } else { weatherContent.textContent='No weather'; }
      }catch{
        newsContent.textContent='Error loading dashboard'; trendContent.textContent=''; weatherContent.textContent=''; scoresContent.textContent='';
      }
    }

    // Init
    loadState(); applyTheme(); if(!activeChatId && chats.length===0){ createNewChat(); } else if(!activeChatId){ activeChatId=chats[chats.length-1].id; }
    renderHistory(); renderChat(); populateDashboard();
  </script>
</body>
</html>
